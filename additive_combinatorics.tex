\documentclass{article}

% preamble
\def\npart{III}
\def\nyear{2024}
\def\nterm{Lent}
\def\nlecturer{Prof Julia Wolf}
\def\ncourse{Introduction to Additive Combinatorics}
\def\draft{Incomplete}

\input{header}

% and here we go!
\begin{document}
\maketitle

\tableofcontents

\clearpage
\section{Fourier-analytic techniques}

\newlec

Let $G = \F_p^n$ where $p$ is a small fixed prime and $n$ is large.

\begin{notation}
  Given a finite set $B$ and any function $f : B \to \C$, write
  $$\E_{x \in B} f(x) = \frac 1{\abs B} \sum_{x \in B} f(x)$$
  Write $\omega = e^{\frac{\tau i}p}$. Note $\sum_{a \in \F_p} \omega^a = 0$.
\end{notation}

\begin{ndef}
  Given $f : \F_p^n \to \C$, define its {\bf Fourier transform} $\hat f : \F_p^n \to \C$ by
  $$\hat f(t) = \E_{x \in \F_p^n} f(x) \omega^{x \cdot t}$$
\end{ndef}

It is easy to verify the {\bf inversion formula}
$$f(x) = \sum_{t \in \F_p^n} \hat f(t)\omega^{-x \cdot t}$$
Indeed,
\begin{align*}
  \sum_{t \in \F_p^n} \hat f(t) \omega^{-x \cdot t}
  & = \sum_{t \in \F_p^n} \left(\E_y f(y)\omega^{y \cdot t}\right) \omega^{-x \cdot t} \\
  & = \E_y f(y) \sum_t \omega^{(y - x) \cdot t} \\
  & = \E_y f(y) 1_{y = x} p^n \\
  & = f(x)
\end{align*}

\begin{notation}
  Given a set $A$ of a finite group $G$, write
  \begin{itemize}
    \item $1_A$ the {\it characteristic function} of $A$, ie
    $$1_A(x) = \begin{cases}
      1 & \text{ if } x \in A \\
      0 & \text{ if } x \nin A
    \end{cases}$$
    \item $\mu_A$ the {\it characteristic measure} of $A$, ie
    $$\mu_A = \alpha^{-1} 1_A$$
    where $\alpha = \frac{\abs A}{\abs G}$.
    \item $f_A$ the {\it balanced function} of $A$, ie
    $$f_A(x) = 1_A(x) - \alpha$$
  \end{itemize}
\end{notation}

Note $\E_x f_A(x) = 0, \E_x \mu_A(x) = 1, \widehat{1_A}(0) = \E_x 1_A(x) = \alpha$. Writing $-A = \{-a | a \in A\}$, we have
\begin{align*}
  \widehat{1_{-A}}(t)
  & = \E_x 1_{-A}(x) \omega^{x \cdot t} \\
  & = \E_x 1_A(-x) \omega^{x \cdot t} \\
  & = \E_x 1_A(x) \omega^{-x \cdot t} \\
  & = \overline{\widehat{1_A}(t)}
\end{align*}

\begin{nex}\label{ex:dft-subspace}
  Let $V \le \F_p^n$. Then
  $$\widehat{1_V}(t) = \E_x 1_V(x) \omega^{x \cdot t} = \frac{\abs V}{\abs G} 1_{V^\perp}(t)$$
  So
  $$\widehat{\mu_V}(t) = 1_{V^\perp}(t)$$
\end{nex}

\begin{nex}\label{ex:dft-random-set}
  Let $R \subseteq \F_p^n$ be such that each $x$ is included with probability $\frac 12$ independently. Then with high probability
  $$\sup_{t \ne 0} \abs{\widehat{1_R}(t)} = O\left(\sqrt{\frac{\log(p^n)}{p^n}}\right)$$
  This is on Example Sheet 1 using a {\bf Chernoff-type bound}: Given $\C$-valued independent random variables $X_1, \dots, X_n$ with mean $0$ and $\theta \ge 0$, we have
  $$\P\left(\abs{\sum_i X_i} \ge \theta\sqrt{\sum_i \norm{X_i}^2_{L^\infty}}\right) \le 4\exp\left(-\frac{\theta^2}4\right)$$
\end{nex}

\begin{nex}
  Let $Q = \{x \in \F_p^n \mid x \cdot x = 0\}$. Then $\abs Q = \left(\frac 1p + O(p^{-n})\right)p^n$ and $\sup_{t \ne 0} \abs{\widehat{1_Q}(t)} = O(p^{-\frac n2})$. See Example Sheet 1.
\end{nex}

\begin{notation}
  Given $f, g : \F_p^n \to \C$, write
  \begin{align*}
    \inn f g & = \E_x f(x) \overline{g(x)} \\
    \inn{\hat f}{\hat g} & = \sum_t \hat f(t) \overline{\hat g(t)}
  \end{align*}
  Consequently,
  \begin{align*}
    \norm f_2^2 & = \E_x \abs{f(x)}^2 \\
    \norm{\hat f}_2^2 & = \sum_t \abs{\hat f(t)}^2
  \end{align*}
\end{notation}

\begin{nlemma}\label{lem:plancherel-parseval}
  For all $f, g : \F_p^n \to \C$,
  \begin{align*}
    \inn f g & = \inn{\hat f}{\hat g} & \text{ (Plancherel)} \\
    \norm f_2 & = \norm{\hat f}_2 & \text{ (Parseval)}
  \end{align*}
\end{nlemma}
\begin{proof}
  Exercise.
\end{proof}

\begin{ndef}\label{def:large-spec}
  Let $\rho > 0$ and $f : \F_p^n \to \C$. Define the $\rho$-large spectrum of $f$ to be
  $$\Spec_\rho(f) = \{t \mid |\hat f(t)| \ge \rho\norm f_1\}$$
\end{ndef}

\begin{nex}
  By Example \ref{ex:dft-subspace}, if $V \le \F_p^n$, then
  $\Spec_\rho(1_V) = V^\perp$ for all $\rho > 0$.
\end{nex}

\begin{nlemma}\label{lem:card-large-spec}
  For all $\rho > 0$, $\abs{\Spec_\rho(f)} \le \rho^{-2} \frac{\norm f_2^2}{\norm f_1^2}$.
\end{nlemma}
\begin{proof}
  $$\norm f_2^2 = \norm{\hat f}_2^2 \ge \sum_{t \in \Spec_\rho(f)} \abs{\hat f(t)}^2 \ge \abs{\Spec_\rho(f)}(\rho \norm f_1)^2$$
\end{proof}

\newlec

\begin{ndef}\label{def:convolution}
  Given $f, g : \F_p^n \to \C$, define their {\bf convolution} $f \ast g : \F_p^n \to \C$ by
  $$(f \ast g)(x) = \E_y f(y)g(x - y)$$
\end{ndef}

\begin{nex}\label{ex:convolution-indicators}
  Given $A, B \subseteq \F_p^n$,
  \begin{align*}
    (1_A \ast 1_B)(x)
    & = \E_y 1_A(y)1_B(x - y) \\
    & = \frac 1{p^n}\abs{A \inter (x - B)} \\
    & = \frac{\#\text{ ways to write } x = a + b, a \in A, b \in B}{p^n}
  \end{align*}
  In particular, the support of $1_A \ast 1_B$ is the {\bf sum set}
  $$A + B = \{a + b \mid a \in A, b \in B\}$$
\end{nex}

\begin{nlemma}\label{lem:dft-convolution}
  Given $f, g : \F_p^n \to \C$,
  $$\widehat{f \ast g}(t) = \hat f(t) \hat g(t)$$
\end{nlemma}
\begin{proof}
  \begin{align*}
    \widehat{f \ast g}(t)
    & = \E_x \left(\E_y f(y)g(x - y)\right)\omega^{x \cdot t} \\
    & = \E_y f(y) \E_u g(u)\omega^{(u + y) \cdot t} \\
    & = \hat f(t) \hat g(t)
  \end{align*}
\end{proof}

\begin{nex}
  $\norm{\hat f}_4^4 = \E_{x + y = z + w} f(x)f(y)\overline{f(z)f(w)}$. See Example Sheet 1.
\end{nex}

\begin{nlemma}[Bogolyubov]
  If $A \subseteq \F_p^n$ is of density $\alpha > 0$, then there exists a subspace $V$ of codimension at most $2\alpha^{-2}$ such that $V \subseteq (A + A) - (A + A)$.
\end{nlemma}
\begin{proof}
  Observe that $(A + A) - (A + A) = \supp (\underbrace{1_A \ast 1_A \ast 1_{-A} \ast 1_{-A}}_g)$, so we wish to find $V$ such that $g(x) > 0$ for all $x \in V$. Let $K = \Spec_\rho(1_A)$ for some $\rho > 0$ and define $V = \langle K\rangle^\perp$. By Lemma \ref{lem:card-large-spec}, $\codim V \le \abs K \le \rho^{-2}\alpha^{-1}$. We calculate
  \begin{align*}
    g(x)
    & = \sum_{t \in \F_p^n} \widehat{1_A \ast 1_A \ast 1_{-A} \ast 1_{-A}}(t)\omega^{-x \cdot t} \\
    & = \sum_{t \in \F_p^n} \abs{\widehat{1_A}(t)}^4 \omega^{-x \cdot t} \\
    & = \alpha^4 + \underbrace{\sum_{t \in K \setminus \{0\}} \abs{\widehat{1_A}(t)}^4 \omega^{-x \cdot t}}_{(1)} + \underbrace{\sum_{t \nin K} \abs{\widehat{1_A}(t)}^4 \omega^{-x \cdot t}}_{(2)}
  \end{align*}
  We now see that
  $$(1) = \sum_{t \in K \setminus \{0\}} \abs{\widehat{1_A}(t)}^4 \ge 0$$
  and
  $$\abs{(2)} \le \sum_{t \nin K} \abs{\widehat{1_A}(t)}^4 \le \sup_{t \nin K} \abs{\widehat{1_A}(t)}^2 \sum_{t \nin K} \abs{\widehat{1_A}(t)}^2 \le (\rho\alpha)^2\norm{1_A}_2^2 = \rho^2\alpha^3$$
  by Parseval. Picking $\rho = \sqrt{\frac\alpha 2}$, we thus get $\rho^2\alpha^3 \le \frac{\alpha^4}2$ and $g(x) > 0$ whenever $x \in V$.
\end{proof}

\begin{nex}
  The set $A = \{x \in \F_2^n \mid \abs x \ge \frac n2 + \frac{\sqrt n}2\}$ has density at least $\frac 14$ but there is no coset $C$ of any subspace of codimension $\sqrt n$ such that $C \subseteq A + A$. See Example Sheet 1.
\end{nex}

\begin{nlemma}\label{lem:density-increment}
  Let $A \subseteq \F_p^n$ of density $\alpha$ be such that $\Spec_\rho(1_A)$ contains some $t \ne 0$. Then there exist $V \le \F_p^n$ of codimension $1$ and $x \in \F_p^n$ such that
  $$\abs{A \inter (x + V)} \ge \alpha\left(1 + \frac\rho 2\right)\abs V$$
\end{nlemma}
\begin{proof}
  Let $t \ne 0$ be such that $\abs{\widehat{1_A}(t)} \ge \rho\alpha$ and let $V = \langle t\rangle^\perp$. For $j = 1, \dots, p$, write
  $$v_j + V = \{x \in \F_p^n \mid x \cdot t = j\}$$
  the cosets of $V$. Then
  \begin{align*}
    \widehat{1_A}(t)
    & = \widehat{f_A}(t) \\
    & = \E_{x \in \F_p^n}(1_A(x)) - \alpha)\omega^{x \cdot t} \\
    & = \E_j \omega^j \E_{x \in v_j + V} (1_A(x) - \alpha) \\
    & = \E_j a_j \omega^j
  \end{align*}
  where $a_j = \frac{\abs{A \inter (v_j + V)}}{\abs V} - \alpha$. Since $\sum_j a_j = 0$, we get
  $$\rho\alpha \le \abs{\widehat{1_A}(t)} \le \E_j \abs{a_j} = \E_j (\abs{a_j} + a_j)$$
  So there is some $j$ such that $\abs{a_j} + a_j \ge \rho\alpha$. In particular, this $a_j$ is positive, so
   $$\frac{\abs{A \inter (v_j + V)}}{\abs V} \ge \alpha + \frac{\rho\alpha}2$$
   as wanted.
\end{proof}

\newlec

\begin{nlemma}\label{lem:3AP-estimate}
  Let $p \ge 3$ and $A \subseteq \F_p^n$ of density $\alpha > 0$ be such that $\sup_{t \ne 0} \abs{\widehat{1_A}(t)} = o(1)$. Then $A$ contains $(\alpha^3 + o(1))\abs G^2$ three terms arithmetic progressions (aka 3AP).
\end{nlemma}

\begin{notation}
  Given $f, g, h : \F_p^n \to \C$, write
  $$T_3(f, g, h) = \E_x f(x) g(x + d) h(x + 2d)$$
  Given $A \subseteq \F_p^n$, write $2 \cdot A = \{2a \mid a \in A\}$. This is distinct from $2A = \{a + b \mid a, b \in A\}$.
\end{notation}

\begin{proof}
  The number of 3AP (including the trivial ones of the form $a, a, a$) in $A$ is $\abs G^2$ times
  \begin{align*}
    T_3(1_A, 1_A, 1_A)
    & = \E_{x, d} 1_A(x) 1_A(x + d) 1_A(x + 2d) \\
    & = \E_{x, y} 1_A(x) 1_A(y) 1_A(2y - x) \\
    & = \E_y (1_A \ast 1_A)(2y) 1_A(y) \\
    & = \inn{1_A \ast 1_A}{1_{2 \cdot A}} \\
    & = \inn{\widehat{1_A}^2}{\widehat{1_{2 \cdot A}}} \\
    & = \alpha^3 + \sum_{t \ne 0} \widehat{1_A}(t)^2 \overline{\widehat{1_{2 \cdot A}}(t)} \text{ by Plancherel}
  \end{align*}
  In absolute value, the error term is at most
  $$\sup_{t \ne 0} \abs{\widehat{1_{2 \cdot A}}(t)} \sum_t \abs{\widehat{1_A}(t)}^2 = \alpha \sup_{t \ne 0} \abs{\widehat{1_A}(t)}$$
\end{proof}

\begin{nthm}[Meshulam]\label{thm:meshulam}
  Let $p \ge 3$ and $A \subseteq \F_p^n$ be a set containing only trivial 3APs. Then
  $$\abs A = O\left(\frac{p^n}{\log(p^n)}\right)$$
\end{nthm}
\begin{proof}
  By assumption, $T_3(1_A, 1_A, 1_A) = \frac\alpha{p^n}$. But, as in Lemma \ref{lem:3AP-estimate},
  $$\abs{T_3(1_A, 1_A, 1_A) - \alpha^3} \le \alpha \sup_{t \ne 0} \abs{\widehat{1_A}(t)}$$
  Hence, provided that $2\alpha^{-2} \le p^n$, Lemma \ref{lem:density-increment} gives us a subspace $V \le \F_p^n$ of codimension $1$ and $x \in \F_p^n$ such that
  $$\abs{A \inter (x + V)} \ge \alpha\left(1 + \frac{\alpha^2}4\right)\abs V$$
  We iterate this observation. Let $A_0 = A, V_0 = \F_p^n$. At step $i$, we are given a set $A_i \subseteq V_i$ of density $\alpha_i$ with only trivial 3APs. Provided that $2\alpha_i^{-2} \le p^{\dim V_i}$, find $V_{i + 1} \le V_i$ of codimension $1$ and $x \in V_i$ such that $\abs{A_i \inter (x + V_i)} \ge \left(\alpha_i + \frac{\alpha_i^2}4\right)\abs{V_{i + 1}}$ and set $A_{i + 1} = (A_i - x) \inter V_i$. Note that $\alpha_{i + 1} \ge \alpha_i + \frac{\alpha_i^2}4$ and $A_{i + 1}$ only contains trivial 3APs (because, very importantly, 3AP are {\bf translation-invariant}). \\
  Through this iteration, the density of $A$ increases from $\alpha$ to $2\alpha$ in at most $\lceil 4\alpha^{-1}\rceil$ steps, from $2\alpha$ to $4\alpha$ in at most $\lceil 2\alpha^{-1}\rceil$ steps, etc... Since density can't increase past $1$, it takes at most
  $$\underbrace{\lceil 4\alpha^{-1}\rceil + \lceil 2\alpha^{-1}\rceil + \dots}_{\lceil \log \alpha^{-1}\rceil \text{ terms}} \le (4\alpha^{-1} + 1) + (2\alpha^{-1} + 1) + \dots \le 8\alpha^{-1} + \log \alpha^{-1} + 1 \le 9\alpha^{-1}$$
  steps to reach a point where the condition $2\alpha_i^{-2} \le p^{\dim V_i}$ is not respected anymore. Now either $\alpha \le \sqrt 2 p^{-\frac n4}$ (in which case the inequality is obvious) or $\alpha \ge \sqrt 2 p^{-\frac n4}$ and
  $$p^{n - 9\alpha^{-1}} \le p^{\dim V_i} \le 2\alpha_i^{-2} \le 2\alpha^{-2} \le p^{\frac n2}$$
  namely $\alpha \le \frac{18}n$, as wanted.
\end{proof}

\newlec

We have proved that if $A \subseteq \F_3^n$ only contains trivial 3APs then $\abs A = O(\frac{3^n}n)$. The largest known set in $\F_3^n$ with only trivial 3APs has size $\ge 2.218^n$ (Tyrrell, 2022). We will return to this later.

From now on, let $G$ be a finite abelian group. $G$ comes equipped with a set of {\bf characters}, ie group homomorphisms $\gamma : G \to \C^\times$. Characters themselves form a group denoted $\hat G$ and called the {\bf Pontryagin dual} (aka {\bf dual group}) of $G$. It turns out that if $G$ is finite abelian then $\hat G \cong G$ (but {\it non-canonically}). For instance,
\begin{itemize}
  \item If $G = \F_p^n$, then $\hat G = \{\gamma_t : x \mapsto \omega^{x \cdot t} \mid t \in G\}$
  \item If $G = \Z/n\Z$, then $\hat G = \{\gamma_t : x \mapsto \omega^{xt} \mid t \in G\}$
\end{itemize}
The latter is a special case of the former, but again $n$ should thought of as an asymptotic variable.

\begin{ndef}
  Given $f : G \to \C$, define its {\bf Fourier transform} $\hat f : \hat G \to \C$ by
  $$\hat f(\gamma) = \E_{x \in G} f(x)\gamma(x)$$
\end{ndef}
It is easy to verify that $f(x) = \sum_{\gamma \in \hat G} \hat f(\gamma) \overline{\gamma(x)}$. Similarly, Definitions \ref{def:large-spec}, \ref{def:convolution}, Examples \ref{ex:dft-random-set}, \ref{ex:convolution-indicators} and Lemmas \ref{lem:plancherel-parseval}, \ref{lem:card-large-spec}, \ref{lem:dft-convolution} go through in this more general context.

\begin{nex}
  Let $p$ be a prime, $L < p$ be even and $J = [-\frac L2, \frac L2] \subseteq \F_p$. Then for all $t \ne 0$ we have
  $$\widehat{1_J}(t) \le \min\left(\frac{L + 1}p, \frac 1{2\abs t}\right)$$
  See Example Sheet 1.
\end{nex}

\begin{nthm}[Roth]
  Let $A \subseteq [N]$ be a set containing only trivial 3APs. Then $\abs A = O(\frac N{\log\log N})$.
\end{nthm}

\begin{nlemma}
  Let $A \subseteq [N]$ of density $\alpha > 0$ containing only trivial 3APs and satisfying $N > 50\alpha^{-2}$. Let $p$ be a prime in $[\frac N3, \frac{2N}3]$ and write $A' = A \inter [p] \subseteq \F_p$. Then either
  \begin{enumerate}
    \item $\sup_{t \ne 0} \abs{\widehat{1_A}(t)} \ge \frac{\alpha^2}{10}$ (where the Fourier coefficients are computed in $\F_p$)
    \item or there exists an interval $J$ of length $\ge \frac N3$ such that
    $$\abs{A \inter J} \ge \alpha\left(1 + \frac\alpha{400}\right)\abs J$$
  \end{enumerate}
\end{nlemma}
\begin{proof}
  If $\abs{A'} \le \alpha\left(1 - \frac\alpha{200}\right)p$, then
  $$\abs{A \inter [p + 1, N]} \ge \alpha(N - p) + \frac{\alpha^2p}{200} \ge \alpha\left(1 + \frac\alpha{400}\right)(N - p)$$
  and we are in Case 2 with $J = [p + 1, N]$. Let $A'' = A' \inter [\frac p3, \frac{2p}3]$. Note that all 3APs of the form $(x, x + d, x + 2d) \in A' \times A'' \times A''$ are in fact 3APs in $[N]$ (and in particular they are trivial). \\
  If $\abs{A' \inter [\frac p3]}$ or $\abs{A' \inter [\frac{2p}3, p]}$ were at least $\frac 25\abs{A'}$, then we would again be in Case 2. We may therefore assume that $\abs{A''} \ge \frac{\abs{A'}}5$. \\
  Now, as in Lemma \ref{lem:3AP-estimate} and Theorem \ref{thm:meshulam} with $\alpha' = \frac{\abs{A'}}p, \alpha'' = \frac{\abs{A''}}p$,
  $$\frac{\alpha''}p = T_3(1_{A'}, 1_{A''}, 1_{A''}) = \alpha'\alpha''^2 + \sum_{t \ne 0}\widehat{1_{A'}}(t)\widehat{1_{A''}}(t)\overline{\widehat{1_{2 \cdot A'}}(t)}$$
  So, as before, $\frac{\alpha'\alpha''}2 \le \alpha''\sup_{t \ne 0} \abs{\widehat{1_{A'}}(t)}$, provided $\frac{\alpha''}p \le \frac{\alpha'\alpha''^2}2$. This holds by assumption since $p \ge \frac N3, N \ge 50\alpha^{-2}, \alpha' \ge \frac{199}{200}\alpha, \alpha'' \ge \frac{\alpha'}5$.
\end{proof}

\newlec

We now want to convert the large Fourier coefficient into a density increment. This is harder now that the number of values of $xt$ grows as $n \to \infty$. Compare this to the finite field case where $x \cdot t$ only take $p$ different values regardless of $n$. If we can't find a single big coefficient, then we might instead be able to find an interval of coefficients whose total contribution is big.

TODO: Insert picture

\begin{nlemma}\label{lem:partition-progressions-small-diam}
  Let $m \in \N$ and $\phi : [m] \to \F_p$ be multiplication by some fixed $t \ne 0$. Given $\eps > 0$, there exists a partition of $[m]$ into progressions $P_i$ of length $\in [\frac{\eps\sqrt m}2, \eps\sqrt m]$ such that $\diam(\phi(P_i)) \le \eps p$.
\end{nlemma}
\begin{proof}
  Let $u = \floor{\sqrt m}$ and consider $0, t, \dots, ut$. By pigeonhole, find $0 \le v < w \le u$ such that $\abs{wt - vt} \le \frac pu$. Set $s = w - v \le u$ so that $\abs{st} \le \frac pu$. Divide $[m]$ into residue classes mod $s$. Each has size at least $\floor{\frac ms} \ge \floor{\frac mu}$ and can be divided into progressions of the form $a, a + s, \dots, a + ds$ with $\frac{\eps u}2 < d \le \eps u$. The diameter of each progression under $\phi$ is $\abs{dst} \le \eps p$.
\end{proof}

\begin{nlemma}
  Let $A \subseteq [N]$ be of density $\alpha > 0$. Let $p$ be a prime in $[\frac N3, \frac{2N}3]$ and write $A' = A \inter [p]$. Suppose there exists $t \ne 0$ such that $\abs{\widehat{1_A}(t)} \ge \frac{\alpha^2}{10}$. Then there exists a progression $p$ of length at least $\alpha^2 \frac{\sqrt N}{500}$ such that
  $$\abs{A \inter P} \ge \alpha\left(1 + \frac\alpha{50}\right)\abs P$$
\end{nlemma}
\begin{proof}
  Let $\eps = \frac{\alpha^2}{40\pi}$ and use Lemma \ref{lem:partition-progressions-small-diam} to partition $[p]$ into progressions $P_i$ of length at least $\frac{\eps \sqrt p}2 \ge \frac{\alpha^2}{80\pi}\sqrt{\frac N3} \ge \frac{\alpha^2\sqrt N}{500}$ and $\diam \phi(P_i) \le \eps p$. Fix one $x_i$ inside each $P_i$.
  \begin{align*}
    \frac{\alpha^2}{10}
    & \le \abs{\widehat{f_{A'}}(t)} \\
    & = \frac 1p\abs{\sum_i\sum_{x \in P_i} f_{A'}(x)\omega^{xt}} \\
    & = \frac 1p\abs{\sum_i\sum_{x \in P_i} f_{A'}(x)\omega^{x_it} + \sum_i\sum_{x \in P_i} f_{A'}(x)(\omega^{xt} - \omega^{x_it})} \\
    & \le \frac 1p\sum_i\abs{\sum_{x \in P_i} f_{A'}(x)\omega^{x_it}} + \frac 1p\sum_i\sum_{x \in P_i} \abs{f_{A'}(x)} 2\pi\eps \\
    & \le \frac 1p\sum_i\abs{\sum_{x \in P_i} f_{A'}(x)\omega^{x_it}} + \frac{\alpha^2}{20}
  \end{align*}
  So
  $$\sum_i \abs{\sum_{x \in P_i} f_{A'}(x)} \ge \frac{\alpha^2p}{20}$$
  Since $f_{A'}$ has mean zero, there exists $i$ such that $\sum_{x \in P_i} f_{A'}(x) \ge \frac{\alpha^2\abs{P_i}}{40}$.
\end{proof}

\begin{proof}[Proof of Roth's theorem]
  Put the ingredients together, Similarly to Meshulam. See Example Sheet 1 for details.
\end{proof}

\begin{nex}[Behrend's construction]
  There exists a set $A \subseteq [N]$ containing non nontrivial 3APs of size at least $e^{-O(\sqrt{\log n})}$. See Example Sheet 1.
\end{nex}

\begin{ndef}
  Let $\Gamma \subseteq \hat G$. The {\bf Bohr set} of {\bf frequencies} $\Gamma$ and width $\rho$ is
  $$B(\Gamma, \rho) = \{x \in G \mid \for \gamma \in \Gamma, \abs{\gamma(x) - 1} \le \rho\}$$
  $\abs\Gamma$ is the {\bf rank} of the Bohr set.
\end{ndef}

\begin{nex}
  When $G = \F_p^n$, $B(\Gamma, \rho) = \langle\Gamma\rangle^\perp$ for all small enough $\rho$ (depending only on $p$, not $n$).
\end{nex}

\begin{nlemma}
  Let $B$ be a Bohr set of rank $d$ and width $\rho$. Then $\abs B \ge \left(\frac\rho{2\pi}\right)^d\abs G$.
\end{nlemma}
\begin{proof}
  See Example Sheet 2.
\end{proof}

\newlec

\begin{nlemma}[Bogolyubov]
  Given $A \subseteq \F_p$ of density $\alpha > 0$, there exists $\Gamma \subseteq \widehat{\F_p}$ of size at most $2\alpha^{-2}$ such that $B(\Gamma, \frac 12) \subseteq (A + A) - (A + A)$.
\end{nlemma}
\begin{proof}
  Recall $(1_A \ast 1_A \ast 1_{-A} \ast 1_{-A})(x) = \sum_{t \in \widehat{\F_p}} \abs{\widehat{1_A}(t)}^4 \omega^{-xt}$. Let $\Gamma = \Spec_{\sqrt{\frac\alpha 2}}(1_A)$ and note that we have $\cos(\frac{2\pi xt}p) > 0$ for all $x \in B(\Gamma, \frac 12)$ and $t \in \Gamma$. Hence
  \begin{align*}
    \Re \sum_{t \in \widehat{\F_p}} \abs{\widehat{1_A}(t)}^4 \omega^{-xt}
    & = \sum_{t \in \Gamma} \abs{\widehat{1_A}(t)}^4 \cos\left(\frac{2\pi xt}p\right) + \sum_{t \notin \Gamma} \abs{\widehat{1_A}(t)}^4 \cos\left(\frac{2\pi xt}p\right) \\
    & \ge \alpha^4 - \frac{\alpha^4}2 > 0
  \end{align*}
\end{proof}

\section{Combinatorial methods}

For now, let $G$ be an abelian group. Given $A, B \subseteq G$, we defined
$$A \pm B = \{a \pm b \mid a \in A, b \in B\}$$
If $A$ and $B$ are finite and nonempty, then
$$\max(\abs A, \abs B) \le \abs{A \pm B} \le \abs A\abs B$$
Better bounds are available in certain settings.

\begin{nex}
  Let $V \le \F_p^n$ be a subspace. Then $V + V$, so $\abs{V + V} = \abs V$. In fact, if $A \subseteq \F_p^n$ is such that $\abs{A + A} = \abs A$, then $A$ is a coset of some subspace.
\end{nex}

\begin{nex}\label{ex:doubling-lt-three-halves}
  Let $A \subseteq \F_p^n$ be such that $\abs{A + A} < \frac 32 \abs A$. Then there exists $V \le \F_p^n$ such that $A$ is contained in a coset of $V$ and $\abs V < \frac 32\abs A$. See Example Sheet 2.
\end{nex}

\begin{nex}
  Let $A \subseteq \F_p^n$ be a set of linearly independent vectors. Then $\abs{A + A} = \binom{\abs A + 1}2$. This is big doubling, but $\abs A \le n$ is small! \\
  Let $A \subseteq \F_p^n$ be a set where each point is taken randomly with probability $p^{-\theta n}$ where $\theta \in ]\frac 12, 1]$. Then with high probability $\abs{A + A} = (1 + o(1))\frac{\abs A^2}2$.
\end{nex}

\begin{ndef}
  Given finite sets $A, B \subseteq G$, we define the Ruzsa distance between $A$ and $B$ to be
  $$d(A, B) = \log \frac{\abs{A - B}}{\sqrt{\abs A\abs B}}$$
\end{ndef}

$d(A, B)$ is clearly nonnegative and symmetric. However, $d(A, A) \ne 0$ in general.

\begin{nlemma}[Ruzsa's triangle inequality]\label{lem:ruzsa-triangle}
  For $A, B, C \subseteq G$ finite,
  $$d(A, C) \le d(A, B) + d(B, C)$$
\end{nlemma}
\begin{proof}
  The inequality reduces to
  $$\abs B\abs{A - C} \le \abs{A - B}\abs{B - C}$$
  This is true because
  \begin{align*}
    \phi : B \times (A - C) & \to (A - B) \times (B - C) \\
    (b, d) & \mapsto (a_d - b, b - c_d)
  \end{align*}
  is injective, where for each $d \in A - C$ we have chosen $a_d \in A, c_d \in C$ such that $d = a - c$.
\end{proof}

\begin{ndef}
  Given a finite set $A \subseteq G$, we write $\sigma(A) = \frac{\abs{A + A}}{\abs A}$ the {\bf doubling constant} and $\delta(A) = \frac{\abs{A - A}}{\abs A}$ the {\bf difference constant} of $A$.
\end{ndef}

$d(A, A) = \log \sigma(A)$ and $d(A, -A) = \log \delta(A)$, so Lemma \ref{lem:ruzsa-triangle} for $A, -A, -A$ tells us that $\delta(A) \le \sigma(A)^2$.

\newlec

\begin{notation}
  Given $A \subseteq G$ and $\ell, m \in \N$, write $\ell A - m A$ for the set
  $$\underbrace{A + \dots + A}_{\ell \text{ times}} - \underbrace{A + \dots + A}_{m \text{ times}}$$
\end{notation}

\begin{nthm}[Plünnecke's inequality]
  Let $A, B \subseteq G$ be finite such that $\abs{A + B} \le K\abs A$. Then for all $\ell, m$,
  $$\abs{\ell B - mB} \le K^{\ell + m}\abs A$$
\end{nthm}
\begin{idea}
  $A$ should be thought of as being approximately a subspace. The assumption then says that $B$ is efficiently contained in (a translate of) $A$ and the conclusion now reads that $B$ must itself have small multiples. This makes sense, since we can use multiples of $A$ (which are not much bigger than $A$) to efficiently contain the multiples of $B$.
\end{idea}
\begin{proof}
  WLOG $\abs{A + B} = K\abs A$. Choose $A' \subseteq A$ nonempty such that the ratio $\frac{\abs{A' + B}}{\abs{A'}} = K'$ is minimised. Note $K' \le K$ and $\abs{A'' + B} \ge K'\abs{A''}$ for all $A'' \subseteq A$.
  \begin{claim}
    For all finite $C \subseteq G$, $\abs{A' + B + C} \le K'\abs{A' + C}$.
  \end{claim}
  From the claim, we show that $\abs{A' + mB} \le K'^m\abs{A'}$ for all $m$ by induction:
  That's true for $m = 0$. For $m + 1$, the claim with $C = mB$ gives
  $$\abs{A' + (m + 1)B} = \abs{A' + B + C} \le K'\abs{A' + C} \le K'^{m + 1}\abs{A'}$$
  Now, by the triangle inequality,
  $$\abs{A'}\abs{\ell B - mB} \le \abs{A' + \ell B}\abs{A' + mB} \le K'^\ell \abs{A'} K'^m \abs{A'}$$
  Namely, $\abs{\ell B - mB} \le K'^{\ell + m}\abs{A'} \le K^{\ell + m} \abs A$.
  \begin{proof}[Proof of the claim]
    Do induction on $C$. For $C = \emptyset$, it's true. For $C' = C \union \{x\}$ with x $\notin C$, observe that
    \begin{align*}
      A' + B + C'
      & = A' + B + C \union A' + B + x \\
      & = A' + B + C \union A' + B + x \setminus D + B + x
    \end{align*}
    where $D = \{a \in A' \mid a + B + x \subseteq A' + B + C\}$. By definition of $K'$, $\abs{D + B} \ge K'\abs D$, so
    \begin{align*}
      \abs{A' + B + C'}
      & \le \abs{A' + B + C} + \abs{A' + B + x \setminus D + B + x} \\
      & \le \abs{A' + B + C} + \abs{A' + B} - \abs{D + B} \\
      & \le K'\abs{A' + C} + K'\abs{A'} - K'\abs D \\
      & = K'(\abs{A' + C} + \abs{A'} - \abs D)
    \end{align*}
    We now apply the same argument again, writing
    $$A' + C' = A' + C \union A' + x \setminus E + x$$
    where $E = \{a \in A' \mid a + x \in A' + C\} \subseteq D$. This time, the union is disjoint, so
    $$\abs{A '+ C'} = \abs{A' + C} + \abs{A'} - \abs E \ge \abs{A' + C} + \abs A - \abs D$$
    Hence $\abs{A' + B + C'} \le K'\abs{A' + C'}$ which proves the claim.
  \end{proof}
\end{proof}

We are now in a position to generalise Example \ref{ex:doubling-lt-three-halves}.

\begin{nthm}[Freiman-Ruzsa]
  Let $A \subseteq \F_p^n$ be such that $\abs{A + A} \le K\abs A$ for some $K > 0$. Then $A$ is contained in a subspace $H \le \F_p^n$ of size $\abs H \le K^2 p^{K^4} \abs A$.
\end{nthm}
\begin{proof}
  Write $S = A - A$ and choose $X \subseteq A + S$ maximal such that the translates $x + A$ for $x \in X$ are disjoint. \\
  $X$ cannot be too large. Indeed, $\forall x \in X, x + A \subseteq 2A + S$. Hence $\Union_{x \in X} (x + A) \subseteq 2A + S$ and $\abs X\abs A = \abs{\Union_{x \in X} (x + A)} \le \abs{2A + S} \le K^4\abs A$ by Plünnecke, namely $\abs X \le K^4$. \\
  Now observe that $A + S \subseteq X + S$. Indeed, if $y \in A + S$, then either $y \in X \subseteq X + S$ (because $0 \in S$) or $y \notin X$, meaning that $x + A$ and $y + A$ are not disjoint ($X$ is maximal), namely $y \in x + A - A \subseteq X + S$. \\
  By induction, $\ell A + S \subseteq \ell X + S$ for all $\ell$. Hence, writing
  $$H = \langle A\rangle = \Union_\ell (\ell A + S) \subseteq \Union_\ell (\ell X + S) = \langle X\rangle + S$$
  the subgroup generated by $A$, we see that $A$ is contained in a subgroup of size
  $$\abs H \le \abs{\langle X\rangle}\abs S \le p^{\abs X}K^2\abs A \le K^2p^{K^4}\abs A$$
\end{proof}

\newlec

\begin{nex}
  Let $A = H \union R \subseteq \F_p^n$ where $H$ is a subspace of dimension $K \ll d \ll n - k$ and $R$ consists of $K - 1$ linearly independent vectors in $H^\perp$. Then $\abs A = \abs{H \union R} \sim \abs H$ and $\abs{A + A} = \abs{H \union H + R \union R + R} \sim K\abs H \sim K\abs A$ but any subspace $V \le \F_p^n$ containing $A$ must have size $\ge p^{d + (K - 1)} = p^{K - 1} \abs H \sim p^{K - 1}\abs A$ where the constant is exponential in $K$.
\end{nex}

\begin{nconjecture}[Polynomial Freiman-Ruzsa]
  Let $A \subseteq \F_p^n$ be such that $\abs{A + A} \le K\abs A$. Then there is a subspace $H \le \F_p^n$ of size at most $C_1(K)\abs A$ and $x \in \F_p^n$ such that $\abs{A \inter (x + H)} \ge \frac{\abs A}{C_2(K)}$ where $C_1(K)$ and $C_2(K)$ are polynomials.
\end{nconjecture}

For $p = 2$, this is now a theorem.

\begin{ndef}
  Given an abelian group $G$ and finite sets $A, B \subseteq G$, define {\bf additive quadruples} to be the tuples $(a, a', b, b') \in A^2 \times B^2$ such that $a + b = a' + b'$ and the {\bf additive energy between $A$ and $B$} to be
  $$E(A, B) = \frac{\#\{\text{additive quadruples}\}}{\abs A^{\frac 32}\abs B^{\frac 32}}$$
  Write $E(A) = E(A, A)$ the {\bf additive energy of $A$}.
\end{ndef}

Observe that, if $G$ is finite, then
\begin{align*}
  \abs A^3 E(A)
  & = \abs G^3 \E_{x + y = z + w} 1_A(x)1_A(y)1_A(z)1_A(w) \\
  & = \abs G^3 \norm{\widehat{1_A}}_4^4
\end{align*}

\begin{nex}
  When $H \le \F_p^n$, we have $E(H) = 1$.
\end{nex}

\begin{nlemma}
  Let $G$ be abelian and $A, B \subseteq G$ be finite. Then $E(A, B) \ge \frac{\sqrt{\abs A\abs B}}{\abs{A \pm B}}$. 
\end{nlemma}
\begin{proof}
  Write $r(x) = \#\{(a, b) \in A \times B \mid a + b = x\}$ so that
  $$\abs A^{\frac 32}\abs B^{\frac 32}E(A, B) = \#\{\text{additive quadruples}\} = \sum_x r(x)^2$$
  Observe that $\sum_x r(x) = \abs A\abs B$, therefore
  \begin{align*}
    \abs A^{\frac 32}\abs B^{\frac 32} E(A, B)
    & = \sum_x r(x)^2 \\
    & \ge \frac{\sum_x r(x)1_{A + B}(x)}{\sum_x 1_{A + B}(x)^2} \text{ by Cauchy-Schwarz} \\
    & = \frac{(\abs A\abs B)^2}{\abs{A + B}}
  \end{align*}
  and similarly for $A - B$.
\end{proof}

In particular, if $\abs{A + A} \le K\abs A$ then $E(A) \ge \frac 1K$. The mantra is "Small doubling implies big energy". The converse is {\bf not} true.

\begin{nex}
  Let $G$ be your favorite family of abelian groups. Then there are constants $\eta, \theta > 0$ such that for all sufficiently large $n$ there exists $A \subseteq G$ with $\abs A = n$ satisfying $E(A) \gg \eta$ and $\abs{A + A} \ge \theta \abs A^2$. See Example Sheet 2.
\end{nex}

If we can't hope for a set to have small doubling when its energy is big, we might at least be able to find a big subset with big energy.

\begin{nthm}[Balog-Szemerédi-Gowers]
  Let $G$ be an abelian group and let $A \subseteq G$ be finite such that $E(A) \ge \eta$ for some $\eta > 0$. Then there exists $A' \subseteq A$ of size at least $c(\eta)\abs A$ such that $\abs{A' + A'} \le C(\eta)\abs A$ where $c(\eta)$ and $C(\eta)$ are polynomials in $\eta$.
\end{nthm}

We first prove a technical lemma using a method known as "dependent random choice".

\begin{nlemma}
  Let $A_1, \dots, A_m \subseteq [n]$ and suppose that $\sum_{i, j} \abs{A_i \inter A_j} \ge \delta^2nm^2$. Then there exists $X \subseteq [m]$ of size at least $\frac{\delta^5m}{\sqrt 2}$ such that $\abs{A_i \inter A_j} \ge \frac{\delta^2n}2$ for at least 90\% of the pairs $(i, j) \in X^2$.
\end{nlemma}
\begin{proof}
  Let $x_1, \dots, x_5$ be taken uniformly at random from $[n]$ and let
  $$X = \{i \in [m] \mid \forall k, x_k \in A_i\}$$
  Observe that $\P(i, j \in X) = \left(\frac{\abs{A_i \inter A_j}}n\right)^5$. Hence
  $$\frac{\E \abs X^2}{m^2} = \E_{i, j} \P(i, j \in X) \ge \left(\frac{\E_{i, j} \abs{A_i \inter A_j}}n\right)^5 \ge \delta^{10}$$
  Call a pair {\bf bad} if $\abs{A_i \inter A_j} < \frac{\delta^2n}2$. Note that
  $$\P(i, j \in X \mid (i, j) \text{ bad}) = \P(x_1 \in A_i \inter A_j \mid (i, j) \text{ bad})^5 \le \frac{\delta^{10}}{2^5}$$
  Hence
  $$\E[\#\{\text{bad pairs in }X^2\}] \le \frac{\delta^{10}m^2}{2^5}$$
  meaning that
  $$\frac{\delta^{10}m^2}2 + 16\E[\#\{\text{bad pairs in }X^2\}] \le \E[\abs X^2]$$
  We can therefore find $x_1, \dots, x_5$ such that $\frac{\delta^{10}m^2}2 + 16\#\{\text{bad pairs in }X^2\} \le \abs X^2$. This both means that $\abs X \ge \frac{\delta^5m}{\sqrt 2}$ and that
  $$\#\{\text{bad pairs in }X^2\} \le \frac{\abs X^2}{16} \le 10\% \abs X^2$$
\end{proof}

\end{document}